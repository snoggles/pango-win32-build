name: Build Pango Toolchain

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          install: >-
            wget
            patch
            rsync
            tar
            git
            pkg-config
          path-type: inherit

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Rename MSYS2 link.exe
        shell: msys2 {0}
        run: |
          # Rename MSYS2 link.exe to avoid collision with MSVC linker
          if [ -f /usr/bin/link.exe ]; then
            mv /usr/bin/link.exe /usr/bin/link-msys.exe
          fi

      - name: Set up Meson and Ninja
        run: |
          python -m pip install --upgrade pip
          pip install meson==0.59.4 ninja

      - name: Run Build
        shell: msys2 {0}
        env:
          MSYS: winsymlinks:lnk
        run: |
          # The prepare.sh script uses cygpath and other unix tools.
          # Running it inside MSYS2 bash with inherited PATH allows it to find MSVC.
          chmod +x prepare.sh
          ./prepare.sh
